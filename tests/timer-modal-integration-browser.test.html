<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TimerBar and Modal Integration Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../styles/components.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .test-pass { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .test-fail { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .test-info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <div class="container mx-auto p-6">
        <h1 class="text-3xl font-bold mb-6">TimerBar and Modal Integration Test</h1>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Test Controls -->
            <div class="bg-gray-800 rounded-lg p-6">
                <h2 class="text-xl font-semibold mb-4">Test Controls</h2>
                
                <div class="space-y-4">
                    <button id="test-basic-timer" class="w-full py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-white font-medium transition">
                        Test Basic Timer (5s)
                    </button>
                    
                    <button id="test-color-changes" class="w-full py-2 bg-green-600 hover:bg-green-700 rounded-lg text-white font-medium transition">
                        Test Color Changes (3s)
                    </button>
                    
                    <button id="test-expiration" class="w-full py-2 bg-yellow-600 hover:bg-yellow-700 rounded-lg text-white font-medium transition">
                        Test Expiration Callback (2s)
                    </button>
                    
                    <button id="test-minimize-restore" class="w-full py-2 bg-purple-600 hover:bg-purple-700 rounded-lg text-white font-medium transition">
                        Test Minimize/Restore (10s)
                    </button>
                    
                    <button id="test-full-integration" class="w-full py-2 bg-red-600 hover:bg-red-700 rounded-lg text-white font-medium transition">
                        Test Full Integration (8s)
                    </button>
                    
                    <button id="stop-all-tests" class="w-full py-2 bg-gray-600 hover:bg-gray-700 rounded-lg text-white font-medium transition">
                        Stop All Tests
                    </button>
                </div>
                
                <div class="mt-6">
                    <h3 class="text-lg font-medium mb-2">Current Timer State</h3>
                    <div id="timer-state" class="bg-gray-700 p-3 rounded text-sm font-mono">
                        No timer active
                    </div>
                </div>
            </div>
            
            <!-- Test Results -->
            <div class="bg-gray-800 rounded-lg p-6">
                <h2 class="text-xl font-semibold mb-4">Test Results</h2>
                <div id="test-results" class="space-y-2 max-h-96 overflow-y-auto">
                    <div class="test-info">Ready to run tests...</div>
                </div>
            </div>
        </div>
        
        <!-- Mock Modal for Testing -->
        <div id="action-bet-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center p-4">
            <div class="bg-gray-800 rounded-xl shadow-2xl p-6 w-full max-w-sm relative overflow-hidden">
                <!-- Timer Bar Container -->
                <div class="timer-bar-container absolute top-0 left-0 right-0 z-10">
                    <div id="action-bet-timer-bar" class="timer-bar timer-bar-normal"></div>
                </div>
                
                <h2 id="action-bet-title" class="text-2xl font-bold text-yellow-300 text-center mb-2 mt-4">⚡ Test Modal ⚡</h2>
                <p id="action-bet-main-description" class="text-center text-gray-300 mb-4">Testing timer integration</p>
                
                <div id="action-bet-choices" class="space-y-2 mb-4">
                    <button class="w-full py-3 bg-gray-700 hover:bg-indigo-600 rounded-lg text-white font-semibold transition">
                        Test Choice 1 <span class="text-gray-400 text-xs">@2.50</span>
                    </button>
                    <button class="w-full py-3 bg-gray-700 hover:bg-indigo-600 rounded-lg text-white font-semibold transition">
                        Test Choice 2 <span class="text-gray-400 text-xs">@3.00</span>
                    </button>
                </div>
                
                <div class="flex space-x-2">
                    <button id="minimize-modal" class="w-full py-2 bg-gray-600 hover:bg-gray-500 rounded-lg text-white font-medium transition">
                        Minimize
                    </button>
                    <button id="close-modal" class="w-full py-2 bg-red-600 hover:bg-red-500 rounded-lg text-white font-medium transition">
                        Close
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Minimized Indicator -->
        <div id="minimized-indicator" class="hidden fixed top-4 right-4 bg-indigo-600 text-white px-4 py-2 rounded-lg cursor-pointer z-50">
            <div class="text-sm font-medium">Action Bet</div>
            <div id="minimized-time" class="text-xs">10s</div>
        </div>
    </div>

    <!-- Import TimerBar component -->
    <script src="../scripts/timerBar.js"></script>
    
    <script>
        let currentTimer = null;
        let testResults = [];
        let isMinimized = false;
        let minimizedUpdateInterval = null;
        
        // Test utilities
        function addTestResult(message, type = 'info') {
            const resultsContainer = document.getElementById('test-results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result test-${type}`;
            resultDiv.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
            resultsContainer.appendChild(resultDiv);
            resultsContainer.scrollTop = resultsContainer.scrollHeight;
        }
        
        function updateTimerState(state) {
            document.getElementById('timer-state').textContent = state;
        }
        
        function showModal() {
            document.getElementById('action-bet-modal').classList.remove('hidden');
            isMinimized = false;
        }
        
        function hideModal() {
            document.getElementById('action-bet-modal').classList.add('hidden');
            document.getElementById('minimized-indicator').classList.add('hidden');
            isMinimized = false;
            if (minimizedUpdateInterval) {
                clearInterval(minimizedUpdateInterval);
                minimizedUpdateInterval = null;
            }
        }
        
        function minimizeModal() {
            document.getElementById('action-bet-modal').classList.add('hidden');
            document.getElementById('minimized-indicator').classList.remove('hidden');
            isMinimized = true;
        }
        
        function restoreModal() {
            document.getElementById('action-bet-modal').classList.remove('hidden');
            document.getElementById('minimized-indicator').classList.add('hidden');
            isMinimized = false;
            if (minimizedUpdateInterval) {
                clearInterval(minimizedUpdateInterval);
                minimizedUpdateInterval = null;
            }
        }
        
        function stopCurrentTimer() {
            if (currentTimer) {
                currentTimer.stop();
                currentTimer.destroy();
                currentTimer = null;
            }
            hideModal();
            updateTimerState('No timer active');
        }
        
        // Test 1: Basic Timer Functionality (Requirements 2.1, 2.2)
        function testBasicTimer() {
            addTestResult('Starting basic timer test...', 'info');
            stopCurrentTimer();
            showModal();
            
            const duration = 5000;
            currentTimer = new TimerBar('action-bet-modal');
            
            let updateCount = 0;
            currentTimer.onUpdate((remaining, total) => {
                updateCount++;
                updateTimerState(`Timer: ${Math.ceil(remaining/1000)}s remaining (${updateCount} updates)`);
                
                // Verify timer is counting down
                if (updateCount === 1) {
                    if (remaining <= total && remaining > total * 0.9) {
                        addTestResult('✓ Timer started correctly', 'pass');
                    } else {
                        addTestResult('✗ Timer start values incorrect', 'fail');
                    }
                }
            });
            
            currentTimer.onExpired(() => {
                addTestResult('✓ Timer expired callback triggered', 'pass');
                if (updateCount >= 40) { // Should have ~50 updates over 5 seconds
                    addTestResult('✓ Timer updated regularly (~100ms intervals)', 'pass');
                } else {
                    addTestResult(`✗ Timer updates too infrequent (${updateCount} updates)`, 'fail');
                }
                stopCurrentTimer();
            });
            
            currentTimer.start(duration);
            addTestResult('Basic timer test started (5 seconds)', 'info');
        }
        
        // Test 2: Color Changes (Requirements 2.3, 2.4)
        function testColorChanges() {
            addTestResult('Starting color change test...', 'info');
            stopCurrentTimer();
            showModal();
            
            const duration = 3000;
            currentTimer = new TimerBar('action-bet-modal');
            
            let colorStates = [];
            const timerElement = document.getElementById('action-bet-timer-bar');
            
            currentTimer.onUpdate((remaining, total) => {
                const progress = remaining / total;
                let currentColor = 'unknown';
                
                if (timerElement.classList.contains('timer-bar-normal')) currentColor = 'normal';
                else if (timerElement.classList.contains('timer-bar-warning')) currentColor = 'warning';
                else if (timerElement.classList.contains('timer-bar-urgent')) currentColor = 'urgent';
                
                colorStates.push({ progress, color: currentColor });
                updateTimerState(`Timer: ${Math.ceil(remaining/1000)}s, Color: ${currentColor}`);
            });
            
            currentTimer.onExpired(() => {
                // Analyze color transitions
                const normalStates = colorStates.filter(s => s.color === 'normal');
                const warningStates = colorStates.filter(s => s.color === 'warning');
                const urgentStates = colorStates.filter(s => s.color === 'urgent');
                
                if (normalStates.length > 0 && normalStates.every(s => s.progress > 0.5)) {
                    addTestResult('✓ Normal color used for >50% remaining', 'pass');
                } else {
                    addTestResult('✗ Normal color not used correctly', 'fail');
                }
                
                if (warningStates.length > 0 && warningStates.every(s => s.progress <= 0.5 && s.progress > 0.25)) {
                    addTestResult('✓ Warning color used for 25-50% remaining', 'pass');
                } else {
                    addTestResult('✗ Warning color not used correctly', 'fail');
                }
                
                if (urgentStates.length > 0 && urgentStates.every(s => s.progress <= 0.25)) {
                    addTestResult('✓ Urgent color used for <25% remaining', 'pass');
                } else {
                    addTestResult('✗ Urgent color not used correctly', 'fail');
                }
                
                stopCurrentTimer();
            });
            
            currentTimer.start(duration);
            addTestResult('Color change test started (3 seconds)', 'info');
        }
        
        // Test 3: Expiration Callback (Requirement 2.5)
        function testExpiration() {
            addTestResult('Starting expiration test...', 'info');
            stopCurrentTimer();
            showModal();
            
            const duration = 2000;
            const startTime = Date.now();
            currentTimer = new TimerBar('action-bet-modal');
            
            currentTimer.onExpired(() => {
                const actualDuration = Date.now() - startTime;
                const accuracy = Math.abs(actualDuration - duration) / duration;
                
                if (accuracy < 0.1) { // Within 10% accuracy
                    addTestResult(`✓ Timer expired accurately (${actualDuration}ms vs ${duration}ms)`, 'pass');
                } else {
                    addTestResult(`✗ Timer accuracy poor (${actualDuration}ms vs ${duration}ms)`, 'fail');
                }
                
                // Test that timer stopped
                setTimeout(() => {
                    if (!currentTimer.isRunning) {
                        addTestResult('✓ Timer stopped after expiration', 'pass');
                    } else {
                        addTestResult('✗ Timer did not stop after expiration', 'fail');
                    }
                    stopCurrentTimer();
                }, 100);
            });
            
            currentTimer.start(duration);
            addTestResult('Expiration test started (2 seconds)', 'info');
        }
        
        // Test 4: Minimize/Restore Functionality
        function testMinimizeRestore() {
            addTestResult('Starting minimize/restore test...', 'info');
            stopCurrentTimer();
            showModal();
            
            const duration = 10000;
            currentTimer = new TimerBar('action-bet-modal');
            
            let minimizeTime = null;
            let restoreTime = null;
            
            currentTimer.onUpdate((remaining, total) => {
                updateTimerState(`Timer: ${Math.ceil(remaining/1000)}s remaining`);
                
                if (isMinimized) {
                    document.getElementById('minimized-time').textContent = `${Math.ceil(remaining/1000)}s`;
                }
                
                // Minimize after 2 seconds
                if (!minimizeTime && remaining < duration - 2000) {
                    minimizeTime = Date.now();
                    minimizeModal();
                    addTestResult('Modal minimized, timer continues running', 'info');
                    
                    // Start updating minimized indicator
                    minimizedUpdateInterval = setInterval(() => {
                        if (currentTimer && currentTimer.isRunning) {
                            const elapsed = Date.now() - (currentTimer.startTime || Date.now());
                            const remaining = Math.max(0, currentTimer.duration - elapsed);
                            document.getElementById('minimized-time').textContent = `${Math.ceil(remaining/1000)}s`;
                        }
                    }, 1000);
                }
                
                // Restore after 5 seconds
                if (minimizeTime && !restoreTime && remaining < duration - 5000) {
                    restoreTime = Date.now();
                    restoreModal();
                    addTestResult('Modal restored, timer still running', 'info');
                }
            });
            
            currentTimer.onExpired(() => {
                if (minimizeTime && restoreTime) {
                    addTestResult('✓ Timer survived minimize/restore cycle', 'pass');
                } else {
                    addTestResult('✗ Minimize/restore cycle not completed', 'fail');
                }
                stopCurrentTimer();
            });
            
            currentTimer.start(duration);
            addTestResult('Minimize/restore test started (10 seconds)', 'info');
        }
        
        // Test 5: Full Integration Test
        function testFullIntegration() {
            addTestResult('Starting full integration test...', 'info');
            stopCurrentTimer();
            showModal();
            
            const duration = 8000;
            currentTimer = new TimerBar('action-bet-modal');
            
            let testPhases = {
                started: false,
                normalColor: false,
                warningColor: false,
                urgentColor: false,
                minimized: false,
                restored: false,
                expired: false
            };
            
            currentTimer.onUpdate((remaining, total) => {
                const progress = remaining / total;
                const timerElement = document.getElementById('action-bet-timer-bar');
                
                if (!testPhases.started) {
                    testPhases.started = true;
                    addTestResult('✓ Timer started and updating', 'pass');
                }
                
                // Check color states
                if (progress > 0.5 && timerElement.classList.contains('timer-bar-normal')) {
                    if (!testPhases.normalColor) {
                        testPhases.normalColor = true;
                        addTestResult('✓ Normal color active', 'pass');
                    }
                }
                
                if (progress <= 0.5 && progress > 0.25 && timerElement.classList.contains('timer-bar-warning')) {
                    if (!testPhases.warningColor) {
                        testPhases.warningColor = true;
                        addTestResult('✓ Warning color active', 'pass');
                    }
                }
                
                if (progress <= 0.25 && timerElement.classList.contains('timer-bar-urgent')) {
                    if (!testPhases.urgentColor) {
                        testPhases.urgentColor = true;
                        addTestResult('✓ Urgent color active', 'pass');
                    }
                }
                
                // Test minimize at 60% completion
                if (progress < 0.4 && !testPhases.minimized) {
                    testPhases.minimized = true;
                    minimizeModal();
                    addTestResult('✓ Modal minimized during timer', 'pass');
                    
                    // Restore after 1 second
                    setTimeout(() => {
                        if (!testPhases.restored) {
                            testPhases.restored = true;
                            restoreModal();
                            addTestResult('✓ Modal restored during timer', 'pass');
                        }
                    }, 1000);
                }
                
                updateTimerState(`Integration test: ${Math.ceil(remaining/1000)}s remaining`);
            });
            
            currentTimer.onExpired(() => {
                testPhases.expired = true;
                
                // Check all phases completed
                const completedPhases = Object.values(testPhases).filter(Boolean).length;
                const totalPhases = Object.keys(testPhases).length;
                
                if (completedPhases === totalPhases) {
                    addTestResult(`✓ Full integration test passed (${completedPhases}/${totalPhases} phases)`, 'pass');
                } else {
                    addTestResult(`✗ Integration test incomplete (${completedPhases}/${totalPhases} phases)`, 'fail');
                }
                
                stopCurrentTimer();
            });
            
            currentTimer.start(duration);
            addTestResult('Full integration test started (8 seconds)', 'info');
        }
        
        // Event listeners
        document.getElementById('test-basic-timer').addEventListener('click', testBasicTimer);
        document.getElementById('test-color-changes').addEventListener('click', testColorChanges);
        document.getElementById('test-expiration').addEventListener('click', testExpiration);
        document.getElementById('test-minimize-restore').addEventListener('click', testMinimizeRestore);
        document.getElementById('test-full-integration').addEventListener('click', testFullIntegration);
        document.getElementById('stop-all-tests').addEventListener('click', stopCurrentTimer);
        
        document.getElementById('minimize-modal').addEventListener('click', minimizeModal);
        document.getElementById('close-modal').addEventListener('click', hideModal);
        document.getElementById('minimized-indicator').addEventListener('click', restoreModal);
        
        // Initialize
        addTestResult('TimerBar integration test suite loaded', 'info');
        addTestResult('Click any test button to begin', 'info');
    </script>
</body>
</html>